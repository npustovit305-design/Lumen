name: Build LuminaOS ISO

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - 'live-build/**'
      - 'calamares/**'
      - 'branding/**'
      - '.github/workflows/build-iso.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      LB_DEBUG: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            live-build debootstrap syslinux-common isolinux \
            squashfs-tools xorriso git wget curl ca-certificates gnupg \
            fakeroot
          sudo apt-get clean

      - name: Configure live-build
        working-directory: live-build
        run: |
          sudo lb clean
          sudo bash ./auto/config

      - name: Build ISO
        working-directory: live-build
        run: |
          sudo lb build
          sudo cp -f ../live-image-amd64.hybrid.iso "$GITHUB_WORKSPACE/LuminaOS-gnome-amd64.iso" || true
          # Some lb versions output into parent dir; ensure artifact exists
          if [ ! -f "$GITHUB_WORKSPACE/LuminaOS-gnome-amd64.iso" ] && [ -f "../live-image-amd64.hybrid.iso" ]; then
            sudo cp ../live-image-amd64.hybrid.iso "$GITHUB_WORKSPACE/LuminaOS-gnome-amd64.iso"
          fi
          if [ ! -f "$GITHUB_WORKSPACE/LuminaOS-gnome-amd64.iso" ] && [ -f "live-image-amd64.hybrid.iso" ]; then
            sudo cp live-image-amd64.hybrid.iso "$GITHUB_WORKSPACE/LuminaOS-gnome-amd64.iso"
          fi

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: LuminaOS-gnome-amd64
          path: LuminaOS-gnome-amd64.iso

      - name: Print last 200 lines of live-build logs (always)
        if: always()
        run: |
          echo "Listing logs under live-build/" || true
          find live-build -type f -name "*.log" -print || true
          for f in $(find live-build -type f -name "*.log" 2>/dev/null); do
            echo "========== $f (tail -n 200) =========="
            tail -n 200 "$f" || true
          done

      - name: Upload build logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lb-logs
          path: |
            live-build/*.log
            live-build/*/*.log

      - name: Create release and upload ISO (manual runs only)
        if: github.event_name == 'workflow_dispatch' && success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly-${{ github.run_number }}
          name: LuminaOS nightly ${{ github.run_number }}
          draft: false
          prerelease: true
          files: |
            LuminaOS-gnome-amd64.iso
