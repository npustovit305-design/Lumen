name: Build LuminaOS ISO

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - 'live-build/**'
      - 'calamares/**'
      - 'branding/**'
      - '.github/workflows/build-iso.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            live-build debootstrap syslinux-common isolinux \
            squashfs-tools xorriso git wget curl ca-certificates gnupg
          sudo apt-get clean

      - name: Configure live-build
        working-directory: live-build
        run: |
          sudo lb clean
          sudo bash ./auto/config

      - name: Build ISO
        working-directory: live-build
        run: |
          sudo lb build
          sudo cp -f ../live-image-amd64.hybrid.iso "$GITHUB_WORKSPACE/LuminaOS-gnome-amd64.iso" || true
          # Some lb versions output into parent dir; ensure artifact exists
          if [ ! -f "$GITHUB_WORKSPACE/LuminaOS-gnome-amd64.iso" ] && [ -f "../live-image-amd64.hybrid.iso" ]; then
            sudo cp ../live-image-amd64.hybrid.iso "$GITHUB_WORKSPACE/LuminaOS-gnome-amd64.iso"
          fi
          if [ ! -f "$GITHUB_WORKSPACE/LuminaOS-gnome-amd64.iso" ] && [ -f "live-image-amd64.hybrid.iso" ]; then
            sudo cp live-image-amd64.hybrid.iso "$GITHUB_WORKSPACE/LuminaOS-gnome-amd64.iso"
          fi

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: LuminaOS-gnome-amd64
          path: LuminaOS-gnome-amd64.iso

      - name: Upload build logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lb-logs
          path: |
            live-build/*.log
            live-build/*/*.log
